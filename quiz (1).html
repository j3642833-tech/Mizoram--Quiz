<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mizoram - Quiz</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
    
    #timer-box { 
    /* The Circular Face */
    width: 80px; 
    height: 80px; 
    border: 5px solid var(--black);
    border-radius: 50%; 
    background: white;
    
    /* Centering the Number */
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 38px; 
    font-weight: 900; 
    color: var(--mizo-red);
    
    /* Position for the Bells */
    margin: 0 auto 20px auto; 
    position: relative; 
}

/* The Alarm Bells (‚è∞ Style) */
#timer-box::before, #timer-box::after {
    content: ''; 
    position: absolute; 
    width: 25px; 
    height: 12px;
    background: var(--black); 
    top: -8px; 
    border-radius: 10px 10px 0 0;
}
#timer-box::before { left: 0px; transform: rotate(-45deg); }
#timer-box::after { right: 0px; transform: rotate(45deg); }

/* The Shake Animation */
.shake { 
    animation: alarm-shake 0.2s infinite; 
    color: var(--wrong-red) !important; 
    border-color: var(--wrong-red) !important; 
}

@keyframes alarm-shake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(6deg); }
    75% { transform: rotate(-6deg); }
}

        :root { --mizo-red: #cc0000; --white: #ffffff; --black: #000000; --correct-green: #2ecc71; --wrong-red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--black); color: var(--black); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #setup-screen, #quiz-screen, #result-screen { width: 90%; max-width: 450px; text-align: center; padding: 30px; background: var(--white); border-radius: 25px; border: 4px solid var(--black); }
        .hidden { display: none; }
        .option-btn { display: block; width: 100%; padding: 16px; margin: 12px 0; border: 2px solid var(--black); border-radius: 12px; background: var(--white); color: var(--black); font-size: 16px; font-weight: bold; cursor: pointer; text-align: left; }
        .correct { border-color: var(--correct-green) !important; background: var(--correct-green) !important; color: black !important; }
        .wrong { border-color: var(--wrong-red) !important; background: var(--wrong-red) !important; color: black !important; }
        .primary-btn { background: var(--black); color: var(--white); border: none; padding: 15px 45px; font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 15px; text-transform: uppercase; }
        .secondary-btn { background: var(--white); color: var(--black); border: 2px solid var(--black); padding: 12px 30px; font-size: 16px; border-radius: 50px; cursor: pointer; margin-top: 10px; display: inline-block; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="setup-screen">
        <h1 style="color: var(--black); font-weight: 900;">MIZORAM - QUIZ</h1>
        <p>Zawhna zat tur thlang rawh (5-10)</p>
        <input type="number" id="q-count" value="10" min="5" max="10" style="padding:10px; width:60px; text-align:center; border:2px solid #000;">
        <br><button class="primary-btn" onclick="startQuiz()">TAN RAWH</button>
        <br><a href="leaderboard.html" class="secondary-btn">LEADERBOARD</a>
    </div>

    <div id="quiz-screen" class="hidden">
        <div id="timer-box">12</div>
        <h2 id="question-text" style="color: black;">...</h2>
        <div id="options-container"></div>
        <hr style="border:1px solid #000; margin:20px 0;">
        <div id="score-live" style="font-size: 20px; color: var(--mizo-red); font-weight: bold;">Point: 0</div>
    </div>

    <div id="result-screen" class="hidden">
        <h1 style="color: black; font-weight: 900;">I ZO TA!</h1>
        <div id="final-stats" style="font-size: 22px; margin-bottom: 20px; color: black;"></div>
        <button class="primary-btn" onclick="location.reload()">Play Again</button>
        <br><a href="leaderboard.html" class="secondary-btn">LEADERBOARD EN RAWH</a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDNXG3makDQ0L5XmBSuJEByWg3xHCFiWQY",
            databaseURL: "https://mizoram-quiz-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mizoram-quiz"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const tickSnd = new Audio('https://www.soundjay.com/buttons/button-09.mp3');
        const correctSnd = new Audio('https://www.soundjay.com/buttons/button-3.mp3');
        const wrongSnd = new Audio('https://www.soundjay.com/buttons/button-10.mp3');

        const masterQuestions = [
            { id: 1, q: "Mizoram-ah District engzat nge awm?", a: "11", o: ["8", "11", "12", "13"] },
            { id: 2, q: "Aizawl atanga Lunglei inkar hlat zawng (NH-54)?", a: "165 km", o: ["120 km", "165 km", "235 km", "190 km"] },
            { id: 3, q: "Mizo thufing: 'Sairil phung ...'?", a: "In thlah lo", o: ["In thlah lo", "A tlan chak", "A mawi lo", "A hram ring"] },
            { id: 4, q: "Vantawng Khawhthla a san zawng?", a: "751 ft", o: ["500 ft", "751 ft", "600 ft", "850 ft"] },
            { id: 5, q: "Solomon's Temple-ah hian lung (pillar) engzat nge ding?", a: "12", o: ["4", "8", "12", "16"] },
            { id: 6, q: "Mizoram Assembly Speaker hmasa ber chu tunge?", a: "H. Thansanga", o: ["H. Thansanga", "Pu Hiphei", "Dr. Kenneth Chawngliana", "Pu Rokamlova"] },
            { id: 7, q: "Mizoram University (MZU) awmna khua?", a: "Tanhril", o: ["Durtlang", "Zemabawk", "Tanhril", "Vaivakawn"] },
            { id: 8, q: "Mizo thla zingah 'Thalpui' hi eng thla nge?", a: "February", o: ["January", "February", "March", "April"] },
            { id: 9, q: "Mizo hmeichhe zinga Padma Shree dawng hmasa ber?", a: "Anselm Sawihlira", o: ["B. Sangkhumi", "Anselm Sawihlira", "Lalsangzuali Sailo", "Buangi Sailo"] },
            { id: 10, q: "Mizoram hian State dang engzat nge a dep (border)?", a: "3", o: ["2", "3", "4", "5"] }
        ];

        let currentQuestions = [];
        let qIndex = 0, points = 0, correctCount = 0, wrongCount = 0, timer, timeLeft = 12;

        async function startQuiz() {
            let count = parseInt(document.getElementById('q-count').value) || 10;
            let combinedQuestions = [...masterQuestions];

            try {
                const snapshot = await db.ref('custom_questions').once('value');
                const customData = snapshot.val();
                if (customData) {
                    Object.values(customData).forEach(q => combinedQuestions.push(q));
                }
            } catch (err) { console.error("Sync failed, my lord:", err); }

            let history = JSON.parse(localStorage.getItem('q_history') || "[]");
            let available = combinedQuestions.filter(q => !history.includes(q.id));
            if (available.length < count) { history = []; available = combinedQuestions; }
            
            currentQuestions = available.sort(() => Math.random() - 0.5).slice(0, count);
            currentQuestions.forEach(q => { history.push(q.id); if (history.length > 50) history.shift(); });
            localStorage.setItem('q_history', JSON.stringify(history));

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (qIndex >= currentQuestions.length) return endQuiz();
            timeLeft = 12;
            const timerBox = document.getElementById('timer-box');
            timerBox.innerText = timeLeft;
            timerBox.classList.remove('shake');
            document.getElementById('question-text').innerText = currentQuestions[qIndex].q;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            [...currentQuestions[qIndex].o].sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt, btn);
                container.appendChild(btn);
            });
            timer = setInterval(() => {
                timeLeft--;
                timerBox.innerText = timeLeft;
                if (timeLeft <= 5 && timeLeft > 0) {
                    tickSnd.play();
                    timerBox.classList.add('shake');
                }
                if (timeLeft <= 0) { 
                    clearInterval(timer); 
                    timerBox.classList.remove('shake');
                    handleAnswer(null, null); 
                }
            }, 1000);
        }

        function handleAnswer(selected, btn) {
            clearInterval(timer);
            document.getElementById('timer-box').classList.remove('shake');
            
            // The Repair: Check both answer text and index for Custom Questions
            const currentQ = currentQuestions[qIndex];
            const correctText = currentQ.a;
            const correctIndex = currentQ.correct; // For custom database questions
            
            const buttons = document.querySelectorAll('.option-btn');
            
            // Logic to check if user is correct
            let isCorrect = false;
            if (selected !== null) {
                if (selected === correctText) isCorrect = true;
                // If the answer is stored as an index in the DB
                const allButtons = Array.from(buttons);
                if (correctIndex !== undefined && allButtons[correctIndex] && allButtons[correctIndex].innerText === selected) isCorrect = true;
            }

            if (isCorrect) { 
                correctSnd.play(); 
                points += 5; 
                correctCount++; 
                if(btn) btn.classList.add('correct');
            } else { 
                wrongSnd.play(); 
                wrongCount++; 
                if(btn) btn.classList.add('wrong');
            }

            // Reveal the correct path every time
            buttons.forEach((b, idx) => {
                b.disabled = true;
                if (b.innerText === correctText) b.classList.add('correct');
                if (correctIndex !== undefined && idx === Number(correctIndex)) b.classList.add('correct');
            });

            document.getElementById('score-live').innerText = `Point: ${points}`;
            setTimeout(() => { qIndex++; loadQuestion(); }, 2000);
        }

        function endQuiz() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            let rawName = localStorage.getItem('quiz_user') || "Guest";
            let rawEmail = localStorage.getItem('quiz_email') || "No Email";
            let safeName = rawName.replace(/[.#$\[\]]/g, "_"); 

            const userRef = db.ref('rankings/' + safeName);
            userRef.once('value').then((snapshot) => {
                let d = snapshot.val() || { correct: 0, wrong: 0, points: 0 };
                userRef.set({ 
                    name: rawName, 
                    email: rawEmail,
                    points: (d.points || 0) + points, 
                    correct: (d.correct || 0) + correctCount, 
                    wrong: (d.wrong || 0) + wrongCount 
                });
            });
            document.getElementById('final-stats').innerHTML = `I Score: ${points}<br>Dik zat: ${correctCount} | Dik lo: ${wrongCount}`;
        }
    </script>
</body>
</html>
